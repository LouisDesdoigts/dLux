
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for dLux.">
      
      
        <meta name="author" content="Louis Desdoigts">
      
      
        <link rel="canonical" href="https://louisdesdoigts.github.io/dlux/docs/usage/">
      
      
        <link rel="prev" href="../..">
      
      
        <link rel="next" href="../creating_a_layer/">
      
      <link rel="icon" href="../../material/telescope">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.6">
    
    
      
        <title>Usage - dLux</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.ded33207.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="amber">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#using-lux" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="dLux" class="md-header__button md-logo" aria-label="dLux" data-md-component="logo">
      
  <img src="../../assets/logo.jpg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            dLux
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Usage
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="amber"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
            </label>
          
        
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="amber"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/LouisDesdoigts/dlux" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    louisdesdoigts/dlux
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="dLux" class="md-nav__button md-logo" aria-label="dLux" data-md-component="logo">
      
  <img src="../../assets/logo.jpg" alt="logo">

    </a>
    dLux
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/LouisDesdoigts/dlux" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    louisdesdoigts/dlux
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Tutorials
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Tutorials
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Usage
      </a>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../creating_a_layer/" class="md-nav__link">
        Creating a Layer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/phase_retrieval_demo/" class="md-nav__link">
        Phase Retrieval in dLux
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/designing_a_mask/" class="md-nav__link">
        Phase Mask Design
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/flatfield_calibration/" class="md-nav__link">
        Pixel Level Calibration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/fisher_information/" class="md-nav__link">
        Fisher Information
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/HMC/" class="md-nav__link">
        Numpyro and Hamiltonian Monte Carlo
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          dLux API
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          dLux API
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../API/api/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../API/core/" class="md-nav__link">
        Core
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../API/optics/" class="md-nav__link">
        Optics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../API/apertures/" class="md-nav__link">
        Apertures
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../API/aberrations/" class="md-nav__link">
        Aberrations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../API/propagators/" class="md-nav__link">
        Propagators
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../API/wavefronts/" class="md-nav__link">
        Wavefronts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../API/detectors/" class="md-nav__link">
        Detectors
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../API/sources/" class="md-nav__link">
        Sources
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../API/spectrums/" class="md-nav__link">
        Spectrums
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../API/observations/" class="md-nav__link">
        Observations
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          Utils API
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Utils API
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../API/utils/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../API/optics_util/" class="md-nav__link">
        Optics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../API/models/" class="md-nav__link">
        Models
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../API/units/" class="md-nav__link">
        Units
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../API/math.md" class="md-nav__link">
        Math
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../API/coordinates/" class="md-nav__link">
        Coordinates
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../API/interpolation/" class="md-nav__link">
        Interpolation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../API/bayes/" class="md-nav__link">
        Bayes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../API/helpers/" class="md-nav__link">
        Helpers
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../faq/" class="md-nav__link">
        FAQ & Troubleshooting
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../CHANGELOG/" class="md-nav__link">
        Change Log
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../CONTRIBUTING/" class="md-nav__link">
        Contributing
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="using-lux">Using ∂Lux<a class="headerlink" href="#using-lux" title="Permanent link">¤</a></h1>
<hr />
<p>∂Lux is built in Zodiax, so users should start with the <a href="https://louisdesdoigts.github.io/zodiax/docs/usage/">Using Zodiax Tutorial</a>, which covers the the basics of the framework and how to use the optimisation tools used in ∂Lux.</p>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">¤</a></h2>
<p>∂Lux is an open-source differentiable optical modelling framework harnessing the structural isomorphism between optical systems and neural networks, giving forwards models of optical system as a <em>parametric neural network</em>. In ∂Lux we represent optical systems as a series of layers, each of which applies some transformation to either a wavefront or PSF. The layers are connected in a feed-forward manner, with the output of each layer as the input to the next. This construction allows for very complex optical systems to be parameterised by these layers and for each monochromatic wavefront calculation to be performed in parallel and optimised by Jax.</p>
<p>dLux is designed to be verbose about what is happening under the hood. We think that in order for users to be confident in their results that it is important to be clear about what goes in to that model. Becuase of this dLux tries to avoid 'pre-built' classes and optical systes, allowing users to be flexible in the way they model their systems. This helps users become more familiar with the underlying physics and computational methods and allows them to build more complex configurations.</p>
<div class="admonition note units">
<p class="admonition-title">Note</p>
<p>All units within ∂Lux are SI units. This means that all lengths are in meters, angles are in radians and wavelengths are in meters.</p>
</div>
<hr />
<h2 id="class-overview">Class Overview<a class="headerlink" href="#class-overview" title="Permanent link">¤</a></h2>
<p>∂Lux has Five main classes that are used to model optical systems:</p>
<ol>
<li>
<p><code>Optics</code>: A class that is used to store <code>OpticalLayer</code> classes. <code>OpticalLayer</code> classes perform transformations on the <code>Wavefront</code> class in order to model an optical system. There are three main types of <code>OpticalLayer</code> classes:</p>
<blockquote>
<ul>
<li>Optical Layers: These perform the basic operations on wavefronts such as creation, normalisation, adding phase, optical path differences, titls, rotations etc.</li>
<li>Aperture Layers: This is an expansive module that can be used to create both static and dynamic differentiable apertures. Most used cases are covered by the <code>ApertureFactory</code> class, which can be used to create a variety of single apertures including secondary mirror occulters and spiders.</li>
<li>Propagators: These layers propagate wavefronts between Pupil and Image planes. The most commonly used propagator is the <code>AngularMFT</code> class, which allows for the ouput pixel scale to be specified.</li>
</ul>
</blockquote>
</li>
<li>
<p><code>Detector</code>: A class that is used to store <code>DetectorLayer</code> class. These transformations are used to model the effects of the detector on the PSF.</p>
</li>
<li>
<p><code>Sources</code>: These classes are a series of parameterised source objects.</p>
</li>
<li>
<p><code>Instrument</code>: This class is used to store the <code>Optics</code>, <code>Detector</code> and <code>Source</code> classes. It is used to model the full instrument and is used to calculate the PSF.</p>
</li>
<li>
<p><code>Observation</code>: These are clases that can be used to model complex observation schemes by allowing for the <code>Instrument</code> class to be manipulated in order to create data sets, time series PSFs and more.</p>
</li>
</ol>
<p>In this tutorial we will cover the basics of these classes and how to use them together!</p>
<hr />
<h2 id="a-simple-optical-system">A Simple Optical system<a class="headerlink" href="#a-simple-optical-system" title="Permanent link">¤</a></h2>
<p>Layers that manipulate wavefronts are chained together in a list and passed into a <code>Optics</code> object. There are three types of layers that can be used inside the <code>Optics</code> object. Lets have a quick look at how we would create a basic optical system and model its PSF.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">dLux</span> <span class="k">as</span> <span class="nn">dl</span>

<span class="c1"># Define the parameters of the optical system</span>
<span class="n">aperture_diameter</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># meters</span>
<span class="n">pixel_scale</span>       <span class="o">=</span> <span class="mf">2e-7</span> <span class="c1"># Radians per pixel of the detector</span>
<span class="n">aperture_npixels</span>  <span class="o">=</span> <span class="mi">256</span>  <span class="c1"># Number of pixels representing the wavefront</span>
<span class="n">detector_npixels</span>  <span class="o">=</span> <span class="mi">64</span>   <span class="c1"># Number of pixels in the detector</span>

<span class="c1"># Define our Optical configuration as a list of layers</span>
<span class="n">layers</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># Create a wavefront object</span>
    <span class="n">dl</span><span class="o">.</span><span class="n">CreateWavefront</span><span class="p">(</span><span class="n">aperture_npixels</span><span class="p">,</span> <span class="n">aperture_diameter</span><span class="p">),</span>

    <span class="c1"># Create a Circular Aperture</span>
    <span class="n">dl</span><span class="o">.</span><span class="n">ApertureFactory</span><span class="p">(</span><span class="n">aperture_npixels</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Aperture&#39;</span><span class="p">),</span>

    <span class="c1"># Normalise the wavefront to unity power</span>
    <span class="n">dl</span><span class="o">.</span><span class="n">NormaliseWavefront</span><span class="p">(),</span>

    <span class="c1"># Propagate the wavefront to the detector</span>
    <span class="n">dl</span><span class="o">.</span><span class="n">AngularMFT</span><span class="p">(</span><span class="n">detector_npixels</span><span class="p">,</span> <span class="n">pixel_scale</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Propagator&#39;</span><span class="p">),</span>
<span class="p">]</span>

<span class="c1"># Create the Optics object</span>
<span class="n">optics</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">Optics</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span>

<span class="c1"># Propagate the wavelengths through the optics</span>
<span class="n">wavelengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="mf">1.2e-6</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">psf</span> <span class="o">=</span> <span class="n">optics</span><span class="o">.</span><span class="n">propagate</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">)</span>
</code></pre></div>
<details class="abstract">
<summary>Plotting code</summary>
<div class="highlight"><pre><span></span><code><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;PSF&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">psf</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixles&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Pixles&#39;</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Probability&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;$\sqrt</span><span class="si">{PSF}</span><span class="s2">$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">psf</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixles&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Pixles&#39;</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;assets/simple_psf.png&quot;</span><span class="p">)</span>
</code></pre></div>
</details>
<p><img alt="Simple PSF" src="../assets/simple_psf.png" /></p>
<hr />
<h2 id="working-with-lux-objects">Working with ∂Lux objects<a class="headerlink" href="#working-with-lux-objects" title="Permanent link">¤</a></h2>
<p>∂Lux is built in Zodiax allowing for easy path based manipulation of the objects. Each ∂Lux class has in-built <code>__getattr__</code> methods that allows for individual layers to be accessed by their <code>name</code> parameter (covered in the <a href="https://louisdesdoigts.github.io/zodiax/docs/usage/">Using Zodiax Tutorial</a>). This allows for easy manipulation of the layers in the <code>Optics</code> object. Lets start by examining the <code>optics</code> object which as inbuilt pretty-printing methods:</p>
<div class="highlight"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="n">optics</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">&gt;</span> <span class="n">Optics</span><span class="p">(</span>
<span class="o">&gt;</span>   <span class="n">layers</span><span class="o">=</span><span class="p">{</span>
<span class="o">&gt;</span>     <span class="s1">&#39;CreateWavefront&#39;</span><span class="p">:</span>
<span class="o">&gt;</span>     <span class="n">CreateWavefront</span><span class="p">(</span>
<span class="o">&gt;</span>       <span class="n">name</span><span class="o">=</span><span class="s1">&#39;CreateWavefront&#39;</span><span class="p">,</span>
<span class="o">&gt;</span>       <span class="n">npixels</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
<span class="o">&gt;</span>       <span class="n">diameter</span><span class="o">=</span><span class="n">f32</span><span class="p">[],</span>
<span class="o">&gt;</span>       <span class="n">wavefront_type</span><span class="o">=</span><span class="s1">&#39;Cartesian&#39;</span>
<span class="o">&gt;</span>     <span class="p">),</span>
<span class="o">&gt;</span>     <span class="s1">&#39;Aperture&#39;</span><span class="p">:</span>
<span class="o">&gt;</span>     <span class="n">StaticAperture</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Aperture&#39;</span><span class="p">,</span> <span class="n">aperture</span><span class="o">=</span><span class="n">f32</span><span class="p">[</span><span class="mi">256</span><span class="p">,</span><span class="mi">256</span><span class="p">]),</span>
<span class="o">&gt;</span>     <span class="s1">&#39;NormaliseWavefront&#39;</span><span class="p">:</span>
<span class="o">&gt;</span>     <span class="n">NormaliseWavefront</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;NormaliseWavefront&#39;</span><span class="p">),</span>
<span class="o">&gt;</span>     <span class="s1">&#39;Propagator&#39;</span><span class="p">:</span>
<span class="o">&gt;</span>     <span class="n">AngularMFT</span><span class="p">(</span>
<span class="o">&gt;</span>       <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Propagator&#39;</span><span class="p">,</span>
<span class="o">&gt;</span>       <span class="n">inverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="o">&gt;</span>       <span class="n">npixels_out</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
<span class="o">&gt;</span>       <span class="n">pixel_scale_out</span><span class="o">=</span><span class="n">f32</span><span class="p">[],</span>
<span class="o">&gt;</span>       <span class="n">shift</span><span class="o">=</span><span class="n">f32</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
<span class="o">&gt;</span>       <span class="n">pixel_shift</span><span class="o">=</span><span class="kc">False</span>
<span class="o">&gt;</span>     <span class="p">)</span>
<span class="o">&gt;</span>   <span class="p">}</span>
<span class="o">&gt;</span> <span class="p">)</span>
</code></pre></div>
<p>We can see that the <code>Optics</code> object has a <code>layers</code> attribute which is an <code>OrderedDictionary</code> of the layers that are contained within the <code>Optics</code> object. Each layer has a name attribute which matches the name of the layer what can be used to access the layer. Lets see a practical example of how we can manipulate the optical system to oversample the detector.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Oversample</span>
<span class="n">oversample</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">optics</span> <span class="o">=</span> <span class="n">optics</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="s2">&quot;Propagator.npixels_out&quot;</span><span class="p">,</span> <span class="n">oversample</span><span class="p">)</span>
<span class="n">optics</span> <span class="o">=</span> <span class="n">optics</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="s2">&quot;Propagator.pixel_scale_out&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">oversample</span><span class="p">)</span>

<span class="c1"># Propagate</span>
<span class="n">psf</span> <span class="o">=</span> <span class="n">optics</span><span class="o">.</span><span class="n">propagate</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">)</span>
</code></pre></div>
<details class="abstract">
<summary>Plotting code</summary>
<div class="highlight"><pre><span></span><code><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;PSF&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">psf</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixles&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Pixles&#39;</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Probability&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;$\sqrt</span><span class="si">{PSF}</span><span class="s2">$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">psf</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixles&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Pixles&#39;</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;assets/oversampled_psf.png&quot;</span><span class="p">)</span>
</code></pre></div>
</details>
<p><img alt="Oversampled PSF" src="../assets/oversampled_psf.png" /></p>
<hr />
<h2 id="building-more-complex-systems">Building more complex systems<a class="headerlink" href="#building-more-complex-systems" title="Permanent link">¤</a></h2>
<p>Now we will cover how to use all the different ∂Lux classes with eachother in order to construct a more complex optical system including detector effects and observations.</p>
<h3 id="optics">Optics<a class="headerlink" href="#optics" title="Permanent link">¤</a></h3>
<p>Lets examine how to use the rest of the ∂Lux classes to model a HST-like instrument object. We will use this class to recover and infer parameters of a binary star sytem through optics with a large amount of optical aberrations.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">jax.random</span> <span class="k">as</span> <span class="nn">jr</span>
<span class="kn">import</span> <span class="nn">dLux</span> <span class="k">as</span> <span class="nn">dl</span>
<span class="kn">from</span> <span class="nn">dLux.utils</span> <span class="kn">import</span> <span class="n">arcseconds_to_radians</span> <span class="k">as</span> <span class="n">a2r</span>

<span class="c1"># Define the parameters of the optical system</span>
<span class="n">aperture_npixels</span>   <span class="o">=</span> <span class="mi">256</span>  <span class="c1"># Number of pixels representing the wavefront</span>
<span class="n">aperture_diameter</span>  <span class="o">=</span> <span class="mf">2.4</span>  <span class="c1"># meters</span>
<span class="n">secondary_diameter</span> <span class="o">=</span> <span class="mf">0.35</span> <span class="c1"># meters</span>
<span class="n">strut_diameter</span>     <span class="o">=</span> <span class="mf">0.03</span> <span class="c1"># meters</span>
<span class="n">nstruts</span>            <span class="o">=</span> <span class="mi">4</span>    <span class="c1"># Number of spiders</span>

<span class="c1"># Calcuate values for the aperture</span>
<span class="n">secondary_ratio</span> <span class="o">=</span> <span class="n">secondary_diameter</span> <span class="o">/</span> <span class="n">aperture_diameter</span>
<span class="n">strut_ratio</span> <span class="o">=</span> <span class="n">strut_diameter</span> <span class="o">/</span> <span class="n">aperture_diameter</span>

<span class="c1"># Aberrations</span>
<span class="n">zernikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span> <span class="c1"># 2nd and 3rd radial terms</span>
<span class="n">coefficients</span> <span class="o">=</span> <span class="mf">2e-8</span> <span class="o">*</span> <span class="n">jr</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">jr</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">zernikes</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Detector parameters</span>
<span class="n">pixel_scale</span>        <span class="o">=</span> <span class="n">a2r</span><span class="p">(</span><span class="mf">0.02</span><span class="p">)</span> <span class="c1"># Arcseconds per pixel of the detector</span>
<span class="n">detector_npixels</span>   <span class="o">=</span> <span class="mi">64</span>        <span class="c1"># Number of pixels in the detector</span>
<span class="n">ovsersample</span>        <span class="o">=</span> <span class="mi">3</span>         <span class="c1"># Oversample the detecto</span>


<span class="c1"># Define our Optical configuration as a list of layers</span>
<span class="n">layers</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># Create a wavefront object</span>
    <span class="n">dl</span><span class="o">.</span><span class="n">CreateWavefront</span><span class="p">(</span><span class="n">aperture_npixels</span><span class="p">,</span> <span class="n">aperture_diameter</span><span class="p">),</span>

    <span class="c1"># Create a HST-like Aperture</span>
    <span class="n">dl</span><span class="o">.</span><span class="n">ApertureFactory</span><span class="p">(</span><span class="n">npixels</span>         <span class="o">=</span> <span class="n">aperture_npixels</span><span class="p">,</span> 
                       <span class="n">secondary_ratio</span> <span class="o">=</span> <span class="n">secondary_ratio</span><span class="p">,</span> 
                       <span class="n">nstruts</span>         <span class="o">=</span> <span class="n">nspiders</span><span class="p">,</span> 
                       <span class="n">strut_ratio</span>     <span class="o">=</span> <span class="n">strut_ratio</span><span class="p">,</span>
                       <span class="n">name</span>            <span class="o">=</span> <span class="s1">&#39;Aperture&#39;</span><span class="p">),</span>

    <span class="c1"># Add Zernike Aberrations</span>
    <span class="n">dl</span><span class="o">.</span><span class="n">AberrationFactory</span><span class="p">(</span><span class="n">npixels</span>      <span class="o">=</span> <span class="n">aperture_npixels</span><span class="p">,</span> 
                         <span class="n">zernikes</span>     <span class="o">=</span> <span class="n">zernikes</span><span class="p">,</span> 
                         <span class="n">coefficients</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">,</span> 
                         <span class="n">name</span>         <span class="o">=</span> <span class="s1">&#39;Aberrations&#39;</span><span class="p">),</span>

    <span class="c1"># Normalise the wavefront to unity power</span>
    <span class="n">dl</span><span class="o">.</span><span class="n">NormaliseWavefront</span><span class="p">(),</span>

    <span class="c1"># Propagate the wavefront to the detector</span>
    <span class="n">dl</span><span class="o">.</span><span class="n">AngularMFT</span><span class="p">(</span><span class="n">npixels_out</span>     <span class="o">=</span> <span class="n">detector_npixels</span> <span class="o">*</span> <span class="n">oversample</span><span class="p">,</span> 
                  <span class="n">pixel_scale_out</span> <span class="o">=</span> <span class="n">pixel_scale</span> <span class="o">/</span> <span class="n">oversample</span><span class="p">,</span> 
                  <span class="n">name</span>            <span class="o">=</span> <span class="s1">&#39;Propagator&#39;</span><span class="p">),</span>
<span class="p">]</span>

<span class="c1"># Create the Optics object</span>
<span class="n">optics</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">Optics</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span>

<span class="c1"># Propagate the wavelengths through the optics</span>
<span class="n">wavelengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="mf">1.2e-6</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">psf</span> <span class="o">=</span> <span class="n">optics</span><span class="o">.</span><span class="n">propagate</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">)</span>
</code></pre></div>
<details class="abstract">
<summary>Plotting code</summary>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">colormaps</span>
<span class="n">aberrations</span> <span class="o">=</span> <span class="n">optics</span><span class="o">.</span><span class="n">Aberrations</span><span class="o">.</span><span class="n">get_opd</span><span class="p">()</span>
<span class="n">aperture</span> <span class="o">=</span> <span class="n">optics</span><span class="o">.</span><span class="n">Aperture</span><span class="o">.</span><span class="n">aperture</span>

<span class="n">pupil</span> <span class="o">=</span> <span class="n">aberrations</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">aperture</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">)]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;inferno&#39;</span><span class="p">]</span>
<span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Pupil&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pupil</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;OPD $\mu m$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Pixels&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Pixels&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">psf</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;$\sqrt</span><span class="si">{PSF}</span><span class="s2">$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Pixels&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Pixels&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;assets/hst_like_psf.png&quot;</span><span class="p">)</span>
</code></pre></div>
</details>
<p><img alt="HST-like PSF" src="../assets/hst_like_psf.png" /></p>
<hr />
<h3 id="detector">Detector<a class="headerlink" href="#detector" title="Permanent link">¤</a></h3>
<p>Now lets construct a detector object that we will use to model a jitter and downsample to the correct pixel-scale.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Jitter in pixels</span>
<span class="n">pixel_jitter</span> <span class="o">=</span> <span class="mf">3.</span> <span class="c1"># Pixels</span>

<span class="c1"># Define Detector Layers</span>
<span class="n">detector_layers</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">dl</span><span class="o">.</span><span class="n">ApplyJitter</span><span class="p">(</span><span class="n">pixel_jitter</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Jitter&quot;</span><span class="p">),</span>
    <span class="n">dl</span><span class="o">.</span><span class="n">IntegerDownsample</span><span class="p">(</span><span class="n">oversample</span><span class="p">)</span>
<span class="p">]</span>

<span class="c1"># Construct Detector Object</span>
<span class="n">detector</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">Detector</span><span class="p">(</span><span class="n">detector_layers</span><span class="p">)</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">apply_detector</span><span class="p">(</span><span class="n">psf</span><span class="p">)</span>
</code></pre></div>
<details class="abstract">
<summary>Plotting code</summary>
<div class="highlight"><pre><span></span><code><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Original PSF&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">psf</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixles&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Pixles&#39;</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Probability&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Jittered and downsampled PSF&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixles&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Pixles&#39;</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Probability&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;assets/detector_psf.png&quot;</span><span class="p">)</span>
</code></pre></div>
</details>
<p><img alt="Detector PSF" src="../assets/detector_psf.png" /></p>
<hr />
<h3 id="source">Source<a class="headerlink" href="#source" title="Permanent link">¤</a></h3>
<p>Now lets create a binary source object and propagate it through the optics.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Binary Source Parameters</span>
<span class="n">separation</span> <span class="o">=</span> <span class="n">a2r</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">contrast</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">mean_flux</span> <span class="o">=</span> <span class="mf">1e4</span>

<span class="c1"># Construct Source Object</span>
<span class="n">source</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">BinarySource</span><span class="p">(</span><span class="n">separation</span>  <span class="o">=</span> <span class="n">separation</span><span class="p">,</span> 
                         <span class="n">flux</span>        <span class="o">=</span> <span class="n">mean_flux</span><span class="p">,</span>
                         <span class="n">contrast</span>    <span class="o">=</span> <span class="n">contrast</span><span class="p">,</span> 
                         <span class="n">wavelengths</span> <span class="o">=</span> <span class="n">wavelengths</span><span class="p">,</span>
                         <span class="n">name</span>        <span class="o">=</span> <span class="s1">&#39;Source&#39;</span><span class="p">)</span>

<span class="c1"># Model the PSF</span>
<span class="n">psf</span> <span class="o">=</span> <span class="n">optics</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</code></pre></div>
<details class="abstract">
<summary>Plotting code</summary>
<div class="highlight"><pre><span></span><code><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;PSF&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">psf</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixles&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Pixles&#39;</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Photons&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;$\sqrt</span><span class="si">{PSF}</span><span class="s2">$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">psf</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixles&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Pixles&#39;</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;assets/binary_psf.png&quot;</span><span class="p">)</span>
</code></pre></div>
</details>
<p><img alt="Binary PSF" src="../assets/binary_psf.png" /></p>
<hr />
<h3 id="instrument">Instrument<a class="headerlink" href="#instrument" title="Permanent link">¤</a></h3>
<p>Now we can construct an <code>Instrument</code> object to model all these different components together coherently.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Construct the Telescope Object</span>
<span class="n">tel</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">Instrument</span><span class="p">(</span><span class="n">optics</span>   <span class="o">=</span> <span class="n">optics</span><span class="p">,</span>
                    <span class="n">detector</span> <span class="o">=</span> <span class="n">detector</span><span class="p">,</span>
                    <span class="n">sources</span>  <span class="o">=</span> <span class="p">[</span><span class="n">source</span><span class="p">])</span>

<span class="c1"># Model the PSF</span>
<span class="n">psf</span> <span class="o">=</span> <span class="n">tel</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
</code></pre></div>
<details class="abstract">
<summary>Plotting code</summary>
<div class="highlight"><pre><span></span><code><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;PSF&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">psf</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixles&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Pixles&#39;</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Photons&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;$\sqrt</span><span class="si">{PSF}</span><span class="s2">$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">psf</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixles&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Pixles&#39;</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;assets/instrument_psf.png&quot;</span><span class="p">)</span>
</code></pre></div>
</details>
<p><img alt="Instrument PSF" src="../assets/instrument_psf.png" /></p>
<hr />
<h3 id="observaton-data">Observaton &amp; Data<a class="headerlink" href="#observaton-data" title="Permanent link">¤</a></h3>
<p>Now lets create an observation object in order to model some pointing dithers. Then we will add some photon noise in order to turn this into some data we can recover parameters from.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Construct observation Dithers</span>
<span class="n">dithers</span> <span class="o">=</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">pixel_scale</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">observation</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">Dither</span><span class="p">(</span><span class="n">dithers</span><span class="p">)</span>

<span class="c1"># Set the observation and model</span>
<span class="n">tel</span> <span class="o">=</span> <span class="n">tel</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;observation&#39;</span><span class="p">,</span> <span class="n">observation</span><span class="p">)</span>
<span class="n">psfs</span> <span class="o">=</span> <span class="n">tel</span><span class="o">.</span><span class="n">observe</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">jr</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">jr</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">psfs</span><span class="p">)</span>
</code></pre></div>
<details class="abstract">
<summary>Plotting code</summary>
<div class="highlight"><pre><span></span><code><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image: </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Pixels&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Pixels&quot;</span><span class="p">)</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Photons&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;assets/data.png&quot;</span><span class="p">)</span>
</code></pre></div>
</details>
<p><img alt="Data" src="../assets/data.png" /></p>
<hr />
<h2 id="recovering-parameters">Recovering parameters<a class="headerlink" href="#recovering-parameters" title="Permanent link">¤</a></h2>
<h3 id="initialising-a-model">Initialising a Model<a class="headerlink" href="#initialising-a-model" title="Permanent link">¤</a></h3>
<p>Now that we have some data, lets create a model that we will use to recover the parameters of both the optical system and the source!</p>
<p>We need to start by perturbing the parameters of the optical system and the source.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Perturb values to construct initial model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">tel</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="s1">&#39;Aberrations.coefficients&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="s1">&#39;Jitter.sigma&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="s1">&#39;Source.separation&#39;</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="s1">&#39;Source.flux&#39;</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>

<span class="c1"># Observe the model psfs</span>
<span class="n">psfs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">observe</span><span class="p">()</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Acessing Attributes</p>
<p>The <code>Instrument</code> object also has inbuilt <code>__getattr__</code> methods that allow users to access all of the underlying layers and attributes of the <code>Optics</code>, <code>Detector</code>, <code>Observation</code> and <code>Source</code> objects by their <code>name</code> parameter. Lets see how this works.</p>
<div class="highlight"><pre><span></span><code><span class="n">detector_pixel_scale</span> <span class="o">=</span> <span class="n">tel</span><span class="o">.</span><span class="n">Propagator</span><span class="o">.</span><span class="n">pixel_scale_out</span>
<span class="n">jitter</span> <span class="o">=</span> <span class="n">tel</span><span class="o">.</span><span class="n">Jitter</span><span class="o">.</span><span class="n">sigma</span>
<span class="n">separation</span> <span class="o">=</span> <span class="n">tel</span><span class="o">.</span><span class="n">Source</span><span class="o">.</span><span class="n">separation</span>
</code></pre></div>
<p>All of these can also be access and manipulated using the <code>get</code> and <code>set</code>, <code>multiply</code> methods implemented in Zodiax!</p>
</div>
<details class="abstract">
<summary>Plotting code</summary>
<div class="highlight"><pre><span></span><code><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Residual: </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">psfs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Pixels&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Pixels&quot;</span><span class="p">)</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Photons&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;assets/residuals.png&quot;</span><span class="p">)</span>
</code></pre></div>
</details>
<p><img alt="Residuals" src="../assets/residuals.png" /></p>
<hr />
<h3 id="optimisation">Optimisation<a class="headerlink" href="#optimisation" title="Permanent link">¤</a></h3>
<p>Now we define a loss fucntion and the parameters that we want to recover.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">zodiax</span> <span class="k">as</span> <span class="nn">zdx</span>
<span class="kn">from</span> <span class="nn">jax.scipy.stats</span> <span class="kn">import</span> <span class="n">poisson</span>

<span class="c1"># Define the parameters we want to recover</span>
<span class="n">parameters</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;Aberrations.coefficients&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Source.separation&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Source.flux&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Define the loss function</span>
<span class="nd">@zdx</span><span class="o">.</span><span class="n">filter_jit</span>
<span class="nd">@zdx</span><span class="o">.</span><span class="n">filter_value_and_grad</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">log_likelihood</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">psfs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">observe</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">poisson</span><span class="o">.</span><span class="n">logpmf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">psfs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="c1"># Compile</span>
<span class="n">loss</span><span class="p">,</span> <span class="n">grads</span> <span class="o">=</span> <span class="n">log_likelihood</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Checking Gradients</p>
<p>The <code>grads</code> object that is returned is also a ∂Lux <code>Instrument</code> object! That means we can easily check that the returned gradients are neither nans nor zeros.</p>
</div>
<div class="highlight"><pre><span></span><code><span class="c1"># Examine</span>
<span class="nb">print</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">grads</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parameters</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&gt; -55482.734 [Array([-6.6396436e+03,  9.0544004e+03,  2.0858955e+04,  1.1552759e+11,
       -2.8185054e+11,  3.0387582e+11, -1.5286786e+11], dtype=float32), Array(-2.39274e+10, dtype=float32), Array(1.8175228, dtype=float32)]
</code></pre></div>
<p>Now lets define our learning rates and create a simple optimisation loop.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">optax</span>

<span class="c1"># Define learning rates</span>
<span class="n">zernike_lr</span>    <span class="o">=</span> <span class="mf">1e-8</span>
<span class="n">separation_lr</span> <span class="o">=</span> <span class="mf">1e-8</span>
<span class="n">flux_lr</span>       <span class="o">=</span> <span class="mf">1e2</span>

<span class="c1"># Define the optimizer</span>
<span class="n">optimisers</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">optax</span><span class="o">.</span><span class="n">adam</span><span class="p">(</span><span class="n">zernike_lr</span><span class="p">),</span>
    <span class="n">optax</span><span class="o">.</span><span class="n">adam</span><span class="p">(</span><span class="n">separation_lr</span><span class="p">),</span>
    <span class="n">optax</span><span class="o">.</span><span class="n">adam</span><span class="p">(</span><span class="n">flux_lr</span><span class="p">),</span>
<span class="p">]</span>

<span class="c1"># Optimise</span>
<span class="n">optimiser</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">zdx</span><span class="o">.</span><span class="n">get_optimiser</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">optimisers</span><span class="p">)</span>
<span class="n">losses</span><span class="p">,</span> <span class="n">models</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">loss</span><span class="p">,</span> <span class="n">grads</span> <span class="o">=</span> <span class="n">log_likelihood</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">updates</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">optimiser</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">grads</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">zdx</span><span class="o">.</span><span class="n">apply_updates</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">updates</span><span class="p">)</span>
    <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
    <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

<span class="c1"># Observe the final model</span>
<span class="n">final_psfs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">observe</span><span class="p">()</span>
</code></pre></div>
<p>Lets examine the residuals to see that we have a good model.</p>
<details class="abstract">
<summary>Plotting code</summary>
<div class="highlight"><pre><span></span><code><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Residual: </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">final_psfs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Pixels&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Pixels&quot;</span><span class="p">)</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Photons&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;assets/final_residuals.png&quot;</span><span class="p">)</span>
</code></pre></div>
</details>
<p><img alt="Final Residuals" src="../assets/final_residuals.png" /></p>





                
              </article>
            </div>
          
          
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.expand", "navigation.path", "navigation.indexes", "navigation.top", "content.code.copy", "toc.integrate"], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.51198bba.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>